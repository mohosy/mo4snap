<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>O Tunnel with Centered Starfield</title>

  <!-- modern sans-serif font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /********************************************************
     * GLOBAL + LAYOUT
     ********************************************************/
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      /* allow vertical scroll, hide horizontal */
      overflow-x: hidden;
      overflow-y: auto;
      font-family: 'Montserrat', sans-serif; /* modern font */
      background: black;
      color: white;
    }

    /* the initial tunnel scene takes full viewport height */
    .scene {
      width: 100%;
      height: 100vh;
      perspective: 1200px;
      position: relative;
      transform-style: preserve-3d;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: violentShake 5s ease-in-out;
    }
    @keyframes violentShake {
      0%   { transform: translate(0, 0); }
      20%  { transform: translate(-30px, 30px); }
      40%  { transform: translate(30px, -30px); }
      60%  { transform: translate(-30px, -30px); }
      80%  { transform: translate(30px, 30px); }
      100% { transform: translate(0, 0); }
    }

    /* starfield behind the tunnel */
    #stars-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .star {
      position: absolute;
      width: 20px;
      height: 2px;
      background: linear-gradient(to right, white, transparent);
      opacity: 0;
      animation: starZoom linear infinite;
    }
    @keyframes starZoom {
      0% {
        opacity: 1;
        transform: rotate(var(--rotation)) translateX(0);
      }
      100% {
        opacity: 0;
        transform: rotate(var(--rotation)) translateX(var(--offset));
      }
    }

    /* the "Mo" text that zooms in */
    #mo-container {
      position: absolute;
      z-index: 3;
      animation: zoomIn 12s 5s ease-in-out forwards;
    }
    #mo-text {
      color: white;
      font-size: 80px;
      font-family: Arial, sans-serif;
    }
    @keyframes zoomIn {
      0%   { transform: scale(1);   opacity: 1; }
      99%  { transform: scale(80);  opacity: 1; }
      100% { transform: scale(80);  opacity: 0; }
    }

    /* quick white flash after the "Mo" text zoom */
    #flash {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      pointer-events: none;
      opacity: 0;
      z-index: 2;
      animation: flashAnim 0.5s 6s forwards;
    }
    @keyframes flashAnim {
      0%   { opacity: 1; }
      100% { opacity: 0; }
    }

    /* 3D tunnel behind everything */
    #tunnel-container {
      position: absolute;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      z-index: 1;
    }
    .tunnel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) translateZ(-3500px) rotateZ(0deg);
      transform-style: preserve-3d;
    }
    #tunnel {
      animation: tunnelTravel 15s 6s linear forwards;
    }
    @keyframes tunnelTravel {
      0%   { transform: translate(-50%, -50%) translateZ(-3500px) rotateZ(0deg); }
      100% { transform: translate(-50%, -50%) translateZ(0)       rotateZ(720deg); }
    }
    .tunnel-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      transform-style: preserve-3d;
      transform-origin: center;
      font-size: 40px;
      font-family: Arial, sans-serif;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 80px;
    }

    /* the final scene is positioned absolute so we can fade it in after the tunnel */
    #final-scene {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 2s ease-in-out, transform 3s ease-in-out;
      z-index: 5;
      transform: scale(1);
      will-change: transform;
      backface-visibility: hidden;
      font-family: 'Montserrat', sans-serif;
    }
    #final-scene {
      /* override transition for the scale effect */
      transition: opacity 2s ease-in-out, transform 5s ease-in-out !important;
    }

    /* starfield for the final scene’s background */
    #final-stars-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      pointer-events: none;
      z-index: 0;
    }
    .final-star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      opacity: 0.8;
      animation: twinkle 3s infinite ease-in-out alternate;
    }
    @keyframes twinkle {
      0%   { opacity: 0.2; }
      100% { opacity: 1; }
    }
    .shooting-star {
      position: absolute;
      width: 20px;
      height: 2px;
      background: linear-gradient(to right, white, transparent);
      opacity: 0;
      animation: shootingStarAnim linear infinite;
    }
    @keyframes shootingStarAnim {
      0% {
        opacity: 1;
        transform: rotate(var(--rotation)) translateX(0);
      }
      100% {
        opacity: 0;
        transform: rotate(var(--rotation)) translateX(var(--offset));
      }
    }

    /* text and button in final scene */
    #final-scene h1 {
      margin: 0 0 20px;
      font-size: 2.4em;
      text-align: center;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
      z-index: 1;
    }
    #final-scene p {
      margin: 0 0 20px;
      font-size: 1.2em;
      text-align: center;
      z-index: 1;
    }
    #final-scene #play-btn {
      margin-bottom: 40px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background: #FFD700;
      color: black;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      z-index: 1;
    }

    /* the 6 cards in final scene that lead to each video */
    #cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 30px;
      width: 80%;
      max-width: 800px;
      margin-bottom: 40px;
      z-index: 1;
    }
    #final-scene .card {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 1;
      height: 200px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    /* reflection caption that shows up during videos */
    #video-reflection-caption {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 20px;
      background-color: yellow;
      color: black;
      font-size: 1.2em;
      font-weight: bold;
      border-radius: 6px;
      z-index: 9999;
    }

    /* modern catalog controls */
    #catalog-controls {
      /* show it by default; no gating by watchers */
      display: block;
      background: rgba(255,255,255,0.06);
      padding: 20px;
      margin: 30px auto;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      color: #fff;
      z-index: 10;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }
    #catalog-controls h2 {
      margin-top: 0;
      text-align: center;
      font-weight: 700;
      margin-bottom: 10px;
    }

    /* layout for the listed chapters */
    #chapter-list {
      margin-top: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .chapter-card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .chapter-card h3 {
      margin-top: 0;
      margin-bottom: 5px;
    }

    /* inputs, selects, buttons (consistent style) */
    #catalog-controls input,
    #catalog-controls select,
    #catalog-controls button,
    #catalog-controls textarea {
      margin: 5px;
      padding: 8px 10px;
      border-radius: 4px;
      border: none;
      font-family: 'Montserrat', sans-serif;
      font-size: 0.95em;
    }
    /* consistent dark background for inputs */
    #catalog-controls select,
    #catalog-controls input[type="text"],
    #catalog-controls input[type="number"],
    #catalog-controls textarea {
      background: #333;
      color: #fff;
      border: 1px solid #555;
    }
    /* modern button style */
    #catalog-controls button {
      background: #17b978;
      color: white;
      cursor: pointer;
      border: none;
      transition: background 0.3s;
    }
    #catalog-controls button:hover {
      background: #139f66;
    }

    /* spacing the CRUD section so it doesn’t feel cluttered */
    #crud-operations {
      margin-top: 30px;
    }
    #crud-operations h3 {
      margin-top: 20px;
      margin-bottom: 5px;
      font-size: 1.1em;
      font-weight: 700;
    }

    /* on smaller screens, single column for #chapter-list */
    @media (max-width: 600px) {
      #chapter-list {
        grid-template-columns: 1fr;
      }
      #cards-grid {
        grid-template-columns: 1fr;
      }
    }

    /* hide default media controls on the video elements */
    video::-webkit-media-controls,
    video::-webkit-media-controls-enclosure {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- the initial 3D tunnel scene -->
  <div class="scene">
    <div id="stars-container"></div>
    <div id="mo-container">
      <div id="mo-text">
        <span>M</span><span id="o-target">o</span>
      </div>
    </div>
    <div id="flash"></div>
    <div id="tunnel-container">
      <div class="tunnel" id="tunnel"></div>
    </div>
  </div>

  <!-- background music -->
  <audio id="background-music" src="zoom-in.mp3" autoplay></audio>

  <script>
    /***********************************************************
     * 1) LIFE CHAPTERS DATA
     *    (same as your original, used for the videos & catalog)
     ***********************************************************/
    const lifeChapters = [
      {
        title: "Intro: Working 3 Jobs",
        filename: "data1.mp4",
        category: "Work",
        reflection: "This chapter was all about dedication. I was working three jobs — Code Ninjas, a local boba shop, and as an AI Developer at Pasadena City College — to fund my startup, IRL. I wasn’t doing it out of desperation. I was doing it because I believed in the vision. I’ve invested over $18,000 of my own money to make it real.",
        impact: 80
      },
      {
        title: "Burnout & Reflection",
        filename: "data2.mp4",
        category: "Mental Health",
        reflection: "At one point, I was completely drained. Working nonstop, fasting for Ramadan, and trying to keep up with life. I felt like I was disappearing into my responsibilities. At one point after a shift, I ran across the street to the PCC library, went to the bottom floor and just cried.",
        impact: 85
      },
      {
        title: "Moment of Clarity",
        filename: "data3.mp4",
        category: "Realization",
        reflection: "It was 8:30 AM. I was unlocking the boba shop like always when I passed a crew laying tile, knees on concrete, grinding. We were all just out there—clocked in, going through the motions. But for some reason, that moment hit different. I realized I’d been running on autopilot, trading my time for $17 an hour without ever stopping to ask why. It wasn’t about feeling above it—it was just a wake-up call. I knew I couldn’t keep living like that. I had to build something of my own.",
        impact: 90
      },
      {
        title: "The Escape Plan",
        filename: "data4.mp4",
        category: "Breakthrough",
        reflection: "That moment pushed me to start building GPTify — a tool that lets colleges offer AI-powered student support. I coded every night after work to make it happen.",
        impact: 95
      },
      {
        title: "Building GPTify",
        filename: "data5.mp4",
        category: "Creation",
        reflection: "I turned my skills into something real. I built features, pitched schools, and watched my side hustle start to grow. You can try it now at LansoAI.com.",
        impact: 92
      },
      {
        title: "Moving Forward",
        filename: "data6.mp4",
        category: "Results",
        reflection: "Now, GPTify’s helping real students. PCC asked me to build them a campus app like the one at SMC. IRL’s in the works too — a Gen Z social app backed by my first VC. I just got into UC Irvine’s Computer Science Honors Program, and earlier I was featured on Forbes for launching a nonprofit that helps kids with learning disabilities learn to code. None of this was handed to me. This chapter is proof that I took control — of my time, my freedom, and my future.",
        impact: 100
      }
    ];

    /***********************************************************
     * 2) WATCHERS LOGIC (kept, but no longer gating the catalog)
     *    we won't hide the catalog controls if not all watched.
     *    but we’ll keep the localStorage watchers in case needed.
     ***********************************************************/
    function markVideoWatched(index) {
      let watched = JSON.parse(localStorage.getItem('watchedChapters')) || {};
      watched[index] = true;
      localStorage.setItem('watchedChapters', JSON.stringify(watched));
      // we used to call checkAllVideosWatched() here, but we no longer
      // gate the catalog with it, so we won't do that.
    }

    /***********************************************************
     * 3) REFLECTION CAPTION DURING VIDEO
     ***********************************************************/
    function createReflectionCaption(index) {
      removeReflectionCaption();
      const captionDiv = document.createElement('div');
      captionDiv.id = 'video-reflection-caption';
      captionDiv.textContent = lifeChapters[index].reflection;
      document.body.appendChild(captionDiv);
    }
    function removeReflectionCaption() {
      const existing = document.getElementById('video-reflection-caption');
      if (existing) existing.remove();
    }

    /***********************************************************
     * 4) RENDERING THE CHAPTER CARDS
     *    now with "update results" approach for filter/search/sort
     ***********************************************************/

    // track user preference for sorting, search, filter
    let selectedCategory = 'All';
    let searchTerm = '';
    let sortByImpactDesc = false;

    // re-render function that applies the current filter, search, and sort
    function updateResults() {
      let displayed = lifeChapters.slice();

      // filter by category
      if (selectedCategory !== 'All') {
        displayed = displayed.filter(chap => chap.category === selectedCategory);
      }

      // filter by search
      if (searchTerm.trim() !== '') {
        let lower = searchTerm.toLowerCase();
        displayed = displayed.filter(chap => {
          let t = chap.title.toLowerCase();
          let r = chap.reflection.toLowerCase();
          return t.includes(lower) || r.includes(lower);
        });
      }

      // optional sort by impact desc
      if (sortByImpactDesc) {
        displayed.sort((a, b) => b.impact - a.impact);
      }

      // now show them in #chapter-list
      const listDiv = document.getElementById('chapter-list');
      if (!listDiv) return;
      listDiv.innerHTML = '';

      displayed.forEach(chap => {
        const card = document.createElement('div');
        card.className = 'chapter-card';

        const fileEl = document.createElement('p');
        fileEl.textContent = "filename: " + chap.filename;
        card.appendChild(fileEl);

        const titleEl = document.createElement('h3');
        titleEl.textContent = chap.title;
        card.appendChild(titleEl);

        const catEl = document.createElement('p');
        catEl.textContent = "category: " + chap.category;
        card.appendChild(catEl);

        const impactEl = document.createElement('p');
        impactEl.textContent = "impact: " + chap.impact;
        card.appendChild(impactEl);

        const refEl = document.createElement('p');
        refEl.textContent = "reflection: " + chap.reflection;
        card.appendChild(refEl);

        listDiv.appendChild(card);
      });
    }

    /***********************************************************
     * 5) CRUD functions
     ***********************************************************/
    function addChapter(newChap) {
      lifeChapters.push(newChap);
      updateResults();
    }
    function removeChapterByTitle(title) {
      let idx = lifeChapters.findIndex(ch => ch.title.toLowerCase() === title.toLowerCase());
      if (idx !== -1) {
        lifeChapters.splice(idx, 1);
      }
      updateResults();
    }
    function updateChapter(oldTitle, updated) {
      let idx = lifeChapters.findIndex(ch => ch.title.toLowerCase() === oldTitle.toLowerCase());
      if (idx !== -1) {
        if (updated.title)      lifeChapters[idx].title      = updated.title;
        if (updated.filename)   lifeChapters[idx].filename   = updated.filename;
        if (updated.category)   lifeChapters[idx].category   = updated.category;
        if (updated.reflection) lifeChapters[idx].reflection = updated.reflection;
        if (typeof updated.impact === 'number') {
          lifeChapters[idx].impact = updated.impact;
        }
      }
      updateResults();
    }

    /***********************************************************
     * 6) FULL VIDEO TRANSITION CHAIN
     *    (unchanged logic; we only removed gating from watchers)
     ***********************************************************/
    window.addEventListener('DOMContentLoaded', () => {
      /* 6.1) background music volume fade-in */
      const backgroundMusic = document.getElementById('background-music');
      backgroundMusic.volume = 0.05;
      const volumeInterval = setInterval(() => {
        if (backgroundMusic.volume < 0.3) {
          backgroundMusic.volume = Math.min(0.3, backgroundMusic.volume + 0.01);
        } else {
          clearInterval(volumeInterval);
        }
      }, 200);

      /* 6.2) set transform origin for the "Mo" container */
      const oTarget = document.getElementById('o-target');
      const moContainer = document.getElementById('mo-container');
      const oRect = oTarget.getBoundingClientRect();
      const moRect = moContainer.getBoundingClientRect();
      const xOrigin = oRect.left + oRect.width / 2 - moRect.left;
      const yOrigin = oRect.top + oRect.height / 2 - moRect.top;
      moContainer.style.transformOrigin = `${xOrigin}px ${yOrigin}px`;

      /* 6.3) generate the 350 tunnel rings */
      const tunnel1 = document.getElementById('tunnel');
      function generateTunnelRings(tunnelElem) {
        const ringCount = 350;
        for (let i = 0; i < ringCount; i++) {
          const ring = document.createElement('div');
          ring.className = 'tunnel-ring';
          const depth = i * 10;
          ring.style.transform = `translate(-50%, -50%) translateZ(${depth}px)`;
          const lightness = 90 - (i / ringCount) * 50;
          ring.style.color = `hsl(330, 70%, ${lightness}%)`;
          ring.style.opacity = 1 - (i / ringCount) * 0.5;
          ring.textContent = 'o';
          tunnelElem.appendChild(ring);
        }
      }
      generateTunnelRings(tunnel1);

      /* 6.4) generate initial starfield for the 3D scene */
      const starsContainer = document.getElementById('stars-container');
      const starCount = 100;
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      for (let i = 0; i < starCount; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        let posX, posY;
        if (Math.random() < 0.2) {
          posX = centerX + (Math.random() * 40 - 20);
          posY = centerY + (Math.random() * 40 - 20);
        } else {
          posX = Math.random() * window.innerWidth;
          posY = Math.random() * window.innerHeight;
        }
        star.style.left = `${posX}px`;
        star.style.top = `${posY}px`;
        const angle = Math.atan2(posY - centerY, posX - centerX);
        const angleDeg = angle * 180 / Math.PI;
        star.style.setProperty('--rotation', `${angleDeg}deg`);
        star.style.setProperty('--offset', '500px');
        const duration = 1.5 + Math.random() * 1.5;
        star.style.animationDuration = `${duration}s`;
        const delay = 6 + Math.random();
        star.style.animationDelay = `${delay}s`;
        starsContainer.appendChild(star);
      }

      /* 6.5) after 21s, hide the tunnel and accelerate the stars. */
      setTimeout(() => {
        tunnel1.style.display = "none";
        const stars = document.querySelectorAll('.star');
        const accelerationInterval = setInterval(() => {
          stars.forEach(star => {
            let currentDuration = parseFloat(getComputedStyle(star).animationDuration);
            let newDuration = Math.max(0.2, currentDuration * 0.9);
            star.style.animationDuration = newDuration + "s";
          });
        }, 500);
        setTimeout(() => {
          clearInterval(accelerationInterval);
        }, 38000 - 21000);
      }, 21000);

      /* 6.6) if music hits time>=21s, do the same star acceleration logic */
      backgroundMusic.addEventListener('timeupdate', () => {
        if (backgroundMusic.currentTime >= 21 && tunnel1.style.display !== "none") {
          tunnel1.style.display = "none";
          const stars = document.querySelectorAll('.star');
          const accelerationInterval = setInterval(() => {
            stars.forEach(star => {
              let currentDuration = parseFloat(getComputedStyle(star).animationDuration);
              let newDuration = Math.max(0.2, currentDuration * 0.9);
              star.style.animationDuration = newDuration + "s";
            });
          }, 500);
          setTimeout(() => {
            clearInterval(accelerationInterval);
          }, 38000 - 21000);
        }
      });

      /* 6.7) fade out the "scene", fade in the "final-scene" (catalog + 6 cards) */
      function fadeOutScene() {
        const scene = document.querySelector('.scene');
        scene.style.transition = 'opacity 2s';
        scene.style.opacity = '0';

        setTimeout(() => {
          // build the final-scene div dynamically (like your original)
          const finalScene = document.createElement('div');
          finalScene.id = 'final-scene';

          // starfield for final scene
          const finalStarsContainer = document.createElement('div');
          finalStarsContainer.id = 'final-stars-container';
          finalScene.appendChild(finalStarsContainer);

          // scatter some final stars
          const finalStarCount = 80;
          for (let i = 0; i < finalStarCount; i++) {
            const star = document.createElement('div');
            star.className = 'final-star';
            const x = Math.random() * 100;
            const y = Math.random() * 100;
            star.style.left = x + '%';
            star.style.top = y + '%';
            finalStarsContainer.appendChild(star);
          }
          // some shooting stars
          const shootingStarCount = 6;
          for (let i = 0; i < shootingStarCount; i++) {
            const sstar = document.createElement('div');
            sstar.className = 'shooting-star';
            const xx = Math.random() * window.innerWidth;
            const yy = Math.random() * window.innerHeight;
            sstar.style.left = xx + 'px';
            sstar.style.top = yy + 'px';
            const angle = Math.random() * 360;
            sstar.style.setProperty('--rotation', `${angle}deg`);
            sstar.style.setProperty('--offset', '600px');
            const dur = 1.5 + Math.random() * 2;
            sstar.style.animationDuration = `${dur}s`;
            const del = Math.random() * 10;
            sstar.style.animationDelay = `${del}s`;
            finalStarsContainer.appendChild(sstar);
          }

          // heading + subtitle + play button
          const title = document.createElement('h1');
          title.textContent = 'Welcome to My Catalog Story';
          finalScene.appendChild(title);

          const subtitle = document.createElement('p');
          subtitle.textContent = "click the play button to begin";
          finalScene.appendChild(subtitle);

          const playButton = document.createElement('button');
          playButton.id = 'play-btn';
          playButton.textContent = 'play';
          finalScene.appendChild(playButton);

          // the 6 "cards" with numbers 1..6
          const cardsGrid = document.createElement('div');
          cardsGrid.id = 'cards-grid';
          for (let i = 0; i < 6; i++) {
            const card = document.createElement('div');
            card.className = 'card';
            const numberDiv = document.createElement('div');
            numberDiv.style.fontSize = "100px";
            numberDiv.style.display = "flex";
            numberDiv.style.alignItems = "center";
            numberDiv.style.justifyContent = "center";
            numberDiv.style.width = "100%";
            numberDiv.style.height = "100%";
            numberDiv.textContent = (i + 1);
            card.appendChild(numberDiv);
            cardsGrid.appendChild(card);
          }
          finalScene.appendChild(cardsGrid);

          // the catalog controls container
          const catalogControls = document.createElement('div');
          catalogControls.id = 'catalog-controls';
          catalogControls.innerHTML = `
            <h2>my life chapters</h2>

            <!-- filter by category -->
            <label for="category-select">filter by category:</label>
            <select id="category-select">
              <option value="All">All</option>
              <option value="Work">Work</option>
              <option value="Mental Health">Mental Health</option>
              <option value="Realization">Realization</option>
              <option value="Breakthrough">Breakthrough</option>
              <option value="Creation">Creation</option>
              <option value="Results">Results</option>
            </select>

            <!-- sort impact toggle -->
            <button id="sort-impact-btn">sort by impact (desc)</button>

            <!-- search -->
            <label for="search-input">search (title/reflection):</label>
            <input type="text" id="search-input" placeholder="type to search...">

            <!-- "update results" button -->
            <button id="update-results-btn" style="margin-left: 10px;">update results</button>

            <div id="chapter-list"></div>

            <div id="crud-operations">
              <h3>add chapter</h3>
              <input type="text" id="add-title" placeholder="title">
              <input type="text" id="add-filename" placeholder="filename">
              <input type="text" id="add-category" placeholder="category">
              <textarea id="add-reflection" placeholder="reflection"></textarea>
              <input type="number" id="add-impact" placeholder="impact">
              <button id="add-chapter-btn">add</button>

              <h3>remove chapter</h3>
              <input type="text" id="remove-title" placeholder="title">
              <button id="remove-chapter-btn">remove</button>

              <h3>update chapter</h3>
              <input type="text" id="update-old-title" placeholder="old title">
              <input type="text" id="update-new-title" placeholder="new title">
              <input type="text" id="update-new-filename" placeholder="new filename">
              <input type="text" id="update-new-category" placeholder="new category">
              <textarea id="update-new-reflection" placeholder="new reflection"></textarea>
              <input type="number" id="update-new-impact" placeholder="new impact">
              <button id="update-chapter-btn">update</button>
            </div>
          `;
          finalScene.appendChild(catalogControls);

          // add final-scene to the body
          document.body.appendChild(finalScene);

          // fade it in
          setTimeout(() => {
            finalScene.style.opacity = '1';
          }, 50);

          /* 6.7a) hooking up the catalog UI events (filter, sort, search, CRUD) */
          const catSelectEl = catalogControls.querySelector('#category-select');
          const sortImpactBtn = catalogControls.querySelector('#sort-impact-btn');
          const searchInput = catalogControls.querySelector('#search-input');
          const updateBtn = catalogControls.querySelector('#update-results-btn');

          // toggle sort by impact desc
          sortImpactBtn.addEventListener('click', () => {
            // flip the boolean
            sortByImpactDesc = !sortByImpactDesc;
            if (sortByImpactDesc) {
              sortImpactBtn.textContent = 'sort by impact (desc) [ON]';
            } else {
              sortImpactBtn.textContent = 'sort by impact (desc)';
            }
          });

          // set category whenever user chooses
          catSelectEl.addEventListener('change', e => {
            selectedCategory = e.target.value;
          });

          // capture search term
          searchInput.addEventListener('input', e => {
            searchTerm = e.target.value;
          });

          // actually re-render when user clicks update
          updateBtn.addEventListener('click', updateResults);

          // CRUD logic
          catalogControls.querySelector('#add-chapter-btn').addEventListener('click', () => {
            const t = catalogControls.querySelector('#add-title').value.trim();
            const f = catalogControls.querySelector('#add-filename').value.trim();
            const c = catalogControls.querySelector('#add-category').value.trim();
            const r = catalogControls.querySelector('#add-reflection').value.trim();
            const i = parseInt(catalogControls.querySelector('#add-impact').value.trim()) || 0;
            if (t && f && c && r) {
              addChapter({
                title: t,
                filename: f,
                category: c,
                reflection: r,
                impact: i
              });
            }
          });
          catalogControls.querySelector('#remove-chapter-btn').addEventListener('click', () => {
            const rtitle = catalogControls.querySelector('#remove-title').value.trim();
            if (rtitle) removeChapterByTitle(rtitle);
          });
          catalogControls.querySelector('#update-chapter-btn').addEventListener('click', () => {
            const oldT = catalogControls.querySelector('#update-old-title').value.trim();
            const newT = catalogControls.querySelector('#update-new-title').value.trim();
            const newF = catalogControls.querySelector('#update-new-filename').value.trim();
            const newC = catalogControls.querySelector('#update-new-category').value.trim();
            const newR = catalogControls.querySelector('#update-new-reflection').value.trim();
            const newI = parseInt(catalogControls.querySelector('#update-new-impact').value.trim());
            if (oldT) {
              updateChapter(oldT, {
                title: newT || null,
                filename: newF || null,
                category: newC || null,
                reflection: newR || null,
                impact: isNaN(newI) ? null : newI
              });
            }
          });

          // do an initial render so you see all chapters from the start
          updateResults();

          /* 6.7b) hooking up the "play" button that starts the big 6-video chain */
          playButton.addEventListener('click', () => {
            const cards = document.querySelectorAll('#cards-grid .card');
            const card = cards[0];
            if (!card) return;
            const finalSceneRect = finalScene.getBoundingClientRect();
            const cardRect = card.getBoundingClientRect();
            const cardCenterX = cardRect.left + cardRect.width / 2 - finalSceneRect.left;
            const cardCenterY = cardRect.top + cardRect.height / 2 - finalSceneRect.top;
            finalScene.style.transformOrigin = `${cardCenterX}px ${cardCenterY}px`;
            finalScene.style.transition = "transform 3s ease-in-out";
            finalScene.style.transform = "scale(80)";
            finalScene.addEventListener('transitionend', function handlerZoomIn() {
              finalScene.removeEventListener('transitionend', handlerZoomIn);
              const video1 = document.createElement('video');
              video1.src = "data1.mp4";
              Object.assign(video1.style, {
                position: "fixed",
                top: "0",
                left: "0",
                width: "100%",
                height: "100%",
                objectFit: "cover",
                zIndex: "10"
              });
              video1.autoplay = true;
              video1.controls = false;
              video1.playsInline = true;
              video1.setAttribute('controlsList', 'nodownload nofullscreen noremoteplayback');
              document.body.appendChild(video1);

              video1.addEventListener('play', () => {
                createReflectionCaption(0);
              });
              video1.addEventListener('ended', () => {
                removeReflectionCaption();
                markVideoWatched(0);
              });

              let nextButton1Shown = false;
              video1.addEventListener('timeupdate', () => {
                if (!nextButton1Shown && video1.currentTime >= 60) {
                  nextButton1Shown = true;
                  const nextButton = document.createElement('button');
                  nextButton.id = 'next-btn';
                  nextButton.textContent = 'next';
                  Object.assign(nextButton.style, {
                    position: 'fixed',
                    bottom: '20px',
                    right: '20px',
                    padding: '10px 20px',
                    fontSize: '1em',
                    cursor: 'pointer',
                    borderRadius: '5px',
                    zIndex: 9999
                  });
                  document.body.appendChild(nextButton);

                  const backButton = document.createElement('button');
                  backButton.id = 'back-btn';
                  backButton.textContent = 'back';
                  Object.assign(backButton.style, {
                    position: 'fixed',
                    bottom: '20px',
                    left: '20px',
                    padding: '10px 20px',
                    fontSize: '1em',
                    cursor: 'pointer',
                    borderRadius: '5px',
                    zIndex: 9999
                  });
                  document.body.appendChild(backButton);

                  backButton.addEventListener('click', () => {
                    removeReflectionCaption();
                    backButton.remove();
                    nextButton.remove();
                    video1.pause();
                    video1.remove();
                    finalScene.style.transform = "scale(1)";
                  });

                  nextButton.addEventListener('click', () => {
                    removeReflectionCaption();
                    backButton.remove();
                    nextButton.remove();
                    video1.pause();
                    video1.remove();
                    finalScene.style.transition = "transform 3s ease-in-out";
                    finalScene.style.transform = "scale(1)";
                    finalScene.addEventListener('transitionend', function handlerZoomOut() {
                      finalScene.removeEventListener('transitionend', handlerZoomOut);
                      const cardMiddle = cards[1];
                      if (!cardMiddle) return;
                      const fsRect = finalScene.getBoundingClientRect();
                      const cRect = cardMiddle.getBoundingClientRect();
                      const cx = cRect.left + cRect.width / 2 - fsRect.left;
                      const cy = cRect.top + cRect.height / 2 - fsRect.top;
                      finalScene.style.transformOrigin = `${cx}px ${cy}px`;
                      finalScene.style.transform = "scale(80)";
                      finalScene.addEventListener('transitionend', function handlerZoomIn2() {
                        finalScene.removeEventListener('transitionend', handlerZoomIn2);
                        const video2 = document.createElement('video');
                        video2.src = "data2.mp4";
                        Object.assign(video2.style, {
                          position: "fixed",
                          top: "0",
                          left: "0",
                          width: "100%",
                          height: "100%",
                          objectFit: "cover",
                          zIndex: "10"
                        });
                        video2.autoplay = true;
                        video2.controls = false;
                        video2.playsInline = true;
                        video2.setAttribute('controlsList', 'nodownload nofullscreen noremoteplayback');
                        document.body.appendChild(video2);

                        video2.addEventListener('play', () => {
                          createReflectionCaption(1);
                        });
                        video2.addEventListener('ended', () => {
                          removeReflectionCaption();
                          markVideoWatched(1);
                        });

                        video2.addEventListener('loadedmetadata', () => {
                          video2.addEventListener('timeupdate', function checkTime2() {
                            if (video2.duration && video2.currentTime >= (video2.duration - 5)) {
                              video2.removeEventListener('timeupdate', checkTime2);
                              const nextButton2 = document.createElement('button');
                              nextButton2.id = 'next-btn-2';
                              nextButton2.textContent = 'next';
                              Object.assign(nextButton2.style, {
                                position: 'fixed',
                                bottom: '20px',
                                right: '20px',
                                padding: '10px 20px',
                                fontSize: '1em',
                                cursor: 'pointer',
                                borderRadius: '5px',
                                zIndex: 9999
                              });
                              document.body.appendChild(nextButton2);

                              const backButton2 = document.createElement('button');
                              backButton2.id = 'back-btn-2';
                              backButton2.textContent = 'back';
                              Object.assign(backButton2.style, {
                                position: 'fixed',
                                bottom: '20px',
                                left: '20px',
                                padding: '10px 20px',
                                fontSize: '1em',
                                cursor: 'pointer',
                                borderRadius: '5px',
                                zIndex: 9999
                              });
                              document.body.appendChild(backButton2);

                              backButton2.addEventListener('click', () => {
                                removeReflectionCaption();
                                backButton2.remove();
                                nextButton2.remove();
                                video2.pause();
                                video2.remove();
                                finalScene.style.transform = "scale(1)";

                                finalScene.addEventListener('transitionend', function goBackToVideo1() {
                                  finalScene.removeEventListener('transitionend', goBackToVideo1);
                                  const cardVid1 = cards[0];
                                  if (!cardVid1) return;
                                  const cardRect1 = cardVid1.getBoundingClientRect();
                                  const cardCenterX1 = cardRect1.left + cardRect1.width / 2 - fsRect.left;
                                  const cardCenterY1 = cardRect1.top + cardRect1.height / 2 - fsRect.top;
                                  finalScene.style.transformOrigin = `${cardCenterX1}px ${cardCenterY1}px`;
                                  finalScene.style.transform = "scale(80)";
                                  finalScene.addEventListener('transitionend', function reEnterVideo1() {
                                    finalScene.removeEventListener('transitionend', reEnterVideo1);
                                    const video1again = document.createElement('video');
                                    video1again.src = "data1.mp4";
                                    Object.assign(video1again.style, {
                                      position: "fixed",
                                      top: "0",
                                      left: "0",
                                      width: "100%",
                                      height: "100%",
                                      objectFit: "cover",
                                      zIndex: "10"
                                    });
                                    video1again.autoplay = true;
                                    video1again.controls = false;
                                    video1again.playsInline = true;
                                    video1again.setAttribute('controlsList', 'nodownload nofullscreen noremoteplayback');
                                    document.body.appendChild(video1again);

                                    video1again.addEventListener('play', () => {
                                      createReflectionCaption(0);
                                    });
                                    video1again.addEventListener('ended', () => {
                                      removeReflectionCaption();
                                      markVideoWatched(0);
                                    });

                                    let nextButton1bShown = false;
                                    video1again.addEventListener('timeupdate', () => {
                                      if (!nextButton1bShown && video1again.currentTime >= 60) {
                                        nextButton1bShown = true;
                                        const nextButtonRe1 = document.createElement('button');
                                        nextButtonRe1.id = 'next-btn-re1';
                                        nextButtonRe1.textContent = 'next';
                                        Object.assign(nextButtonRe1.style, {
                                          position: 'fixed',
                                          bottom: '20px',
                                          right: '20px',
                                          padding: '10px 20px',
                                          fontSize: '1em',
                                          cursor: 'pointer',
                                          borderRadius: '5px',
                                          zIndex: 9999
                                        });
                                        document.body.appendChild(nextButtonRe1);

                                        const backButtonRe1 = document.createElement('button');
                                        backButtonRe1.id = 'back-btn-re1';
                                        backButtonRe1.textContent = 'back';
                                        Object.assign(backButtonRe1.style, {
                                          position: 'fixed',
                                          bottom: '20px',
                                          left: '20px',
                                          padding: '10px 20px',
                                          fontSize: '1em',
                                          cursor: 'pointer',
                                          borderRadius: '5px',
                                          zIndex: 9999
                                        });
                                        document.body.appendChild(backButtonRe1);

                                        backButtonRe1.addEventListener('click', () => {
                                          removeReflectionCaption();
                                          backButtonRe1.remove();
                                          nextButtonRe1.remove();
                                          video1again.pause();
                                          video1again.remove();
                                          finalScene.style.transform = "scale(1)";
                                        });

                                        nextButtonRe1.addEventListener('click', () => {
                                          removeReflectionCaption();
                                          backButtonRe1.remove();
                                          nextButtonRe1.remove();
                                          video1again.pause();
                                          video1again.remove();
                                          finalScene.style.transform = "scale(1)";

                                          finalScene.addEventListener('transitionend', function ret1ZoomOut() {
                                            finalScene.removeEventListener('transitionend', ret1ZoomOut);
                                            const card2 = cards[1];
                                            if (!card2) return;
                                            const cardRect2 = card2.getBoundingClientRect();
                                            const cx2 = cardRect2.left + cardRect2.width / 2 - fsRect.left;
                                            const cy2 = cardRect2.top + cardRect2.height / 2 - fsRect.top;
                                            finalScene.style.transformOrigin = `${cx2}px ${cy2}px`;
                                            finalScene.style.transform = "scale(80)";

                                            finalScene.addEventListener('transitionend', function reEnterVideo2() {
                                              finalScene.removeEventListener('transitionend', reEnterVideo2);
                                              const video2b = document.createElement('video');
                                              video2b.src = "data2.mp4";
                                              Object.assign(video2b.style, {
                                                position: "fixed",
                                                top: "0",
                                                left: "0",
                                                width: "100%",
                                                height: "100%",
                                                objectFit: "cover",
                                                zIndex: "10"
                                              });
                                              video2b.autoplay = true;
                                              video2b.controls = false;
                                              video2b.playsInline = true;
                                              video2b.setAttribute('controlsList', 'nodownload nofullscreen noremoteplayback');
                                              document.body.appendChild(video2b);

                                              video2b.addEventListener('play', () => {
                                                createReflectionCaption(1);
                                              });
                                              video2b.addEventListener('ended', () => {
                                                removeReflectionCaption();
                                                markVideoWatched(1);
                                              });
                                            });
                                          });
                                        });
                                      }
                                    });
                                  });
                                });
                              });

                              nextButton2.addEventListener('click', () => {
                                removeReflectionCaption();
                                backButton2.remove();
                                nextButton2.remove();
                                video2.pause();
                                video2.remove();
                                finalScene.style.transition = "transform 3s ease-in-out";
                                finalScene.style.transform = "scale(1)";

                                finalScene.addEventListener('transitionend', function handlerZoomOut2() {
                                  finalScene.removeEventListener('transitionend', handlerZoomOut2);
                                  const cardForVideo3 = cards[2];
                                  if (!cardForVideo3) return;
                                  const fRect2 = finalScene.getBoundingClientRect();
                                  const cRect3 = cardForVideo3.getBoundingClientRect();
                                  const cardCenterX3 = cRect3.left + cRect3.width / 2 - fRect2.left;
                                  const cardCenterY3 = cRect3.top + cRect3.height / 2 - fRect2.top;
                                  finalScene.style.transformOrigin = `${cardCenterX3}px ${cardCenterY3}px`;
                                  finalScene.style.transform = "scale(80)";

                                  finalScene.addEventListener('transitionend', function handlerZoomIn3() {
                                    finalScene.removeEventListener('transitionend', handlerZoomIn3);
                                    const video3 = document.createElement('video');
                                    video3.src = "data3.mp4";
                                    Object.assign(video3.style, {
                                      position: "fixed",
                                      top: "0",
                                      left: "0",
                                      width: "100%",
                                      height: "100%",
                                      objectFit: "cover",
                                      zIndex: "10"
                                    });
                                    video3.autoplay = true;
                                    video3.controls = false;
                                    video3.playsInline = true;
                                    video3.setAttribute('controlsList', 'nodownload nofullscreen noremoteplayback');
                                    document.body.appendChild(video3);

                                    video3.addEventListener('play', () => {
                                      createReflectionCaption(2);
                                    });
                                    video3.addEventListener('ended', () => {
                                      removeReflectionCaption();
                                      markVideoWatched(2);
                                    });

                                    video3.addEventListener('loadedmetadata', () => {
                                      video3.addEventListener('timeupdate', function checkTime3() {
                                        if (video3.currentTime >= 98) {
                                          video3.removeEventListener('timeupdate', checkTime3);
                                          const nextButton3 = document.createElement('button');
                                          nextButton3.id = 'next-btn-3';
                                          nextButton3.textContent = 'next';
                                          Object.assign(nextButton3.style, {
                                            position: 'fixed',
                                            bottom: '20px',
                                            right: '20px',
                                            padding: '10px 20px',
                                            fontSize: '1em',
                                            cursor: 'pointer',
                                            borderRadius: '5px',
                                            zIndex: 9999
                                          });
                                          document.body.appendChild(nextButton3);

                                          const backButton3 = document.createElement('button');
                                          backButton3.id = 'back-btn-3';
                                          backButton3.textContent = 'back';
                                          Object.assign(backButton3.style, {
                                            position: 'fixed',
                                            bottom: '20px',
                                            left: '20px',
                                            padding: '10px 20px',
                                            fontSize: '1em',
                                            cursor: 'pointer',
                                            borderRadius: '5px',
                                            zIndex: 9999
                                          });
                                          document.body.appendChild(backButton3);

                                          backButton3.addEventListener('click', () => {
                                            removeReflectionCaption();
                                            backButton3.remove();
                                            nextButton3.remove();
                                            video3.pause();
                                            video3.remove();
                                            finalScene.style.transform = "scale(1)";

                                            finalScene.addEventListener('transitionend', function backToVideo2() {
                                              finalScene.removeEventListener('transitionend', backToVideo2);
                                              const card2again = cards[1];
                                              if (!card2again) return;
                                              const fsRect = finalScene.getBoundingClientRect();
                                              const c2Rect = card2again.getBoundingClientRect();
                                              const ccx2 = c2Rect.left + c2Rect.width/2 - fsRect.left;
                                              const ccy2 = c2Rect.top + c2Rect.height/2 - fsRect.top;
                                              finalScene.style.transformOrigin = `${ccx2}px ${ccy2}px`;
                                              finalScene.style.transform = "scale(80)";

                                              finalScene.addEventListener('transitionend', function reZoomVid2() {
                                                finalScene.removeEventListener('transitionend', reZoomVid2);
                                                const video2re = document.createElement('video');
                                                video2re.src = "data2.mp4";
                                                Object.assign(video2re.style, {
                                                  position: "fixed",
                                                  top: "0",
                                                  left: "0",
                                                  width: "100%",
                                                  height: "100%",
                                                  objectFit: "cover",
                                                  zIndex: "10"
                                                });
                                                video2re.autoplay = true;
                                                video2re.controls = false;
                                                video2re.playsInline = true;
                                                video2re.setAttribute('controlsList', 'nodownload nofullscreen noremoteplayback');
                                                document.body.appendChild(video2re);

                                                video2re.addEventListener('play', () => {
                                                  createReflectionCaption(1);
                                                });
                                                video2re.addEventListener('ended', () => {
                                                  removeReflectionCaption();
                                                  markVideoWatched(1);
                                                });
                                              });
                                            });
                                          });

                                          nextButton3.addEventListener('click', () => {
                                            removeReflectionCaption();
                                            backButton3.remove();
                                            nextButton3.remove();
                                            video3.pause();
                                            video3.remove();
                                            finalScene.style.transform = "scale(1)";

                                            finalScene.addEventListener('transitionend', function handlerZoomOut3() {
                                              finalScene.removeEventListener('transitionend', handlerZoomOut3);
                                              const cardForVideo4 = cards[3];
                                              if (!cardForVideo4) return;
                                              const fsRect3 = finalScene.getBoundingClientRect();
                                              const cRect4 = cardForVideo4.getBoundingClientRect();
                                              const cardCenterX4 = cRect4.left + cRect4.width / 2 - fsRect3.left;
                                              const cardCenterY4 = cRect4.top + cRect4.height / 2 - fsRect3.top;
                                              finalScene.style.transformOrigin = `${cardCenterX4}px ${cardCenterY4}px`;
                                              finalScene.style.transform = "scale(80)";

                                              finalScene.addEventListener('transitionend', function handlerZoomIn4() {
                                                finalScene.removeEventListener('transitionend', handlerZoomIn4);
                                                const video4 = document.createElement('video');
                                                video4.src = "data4.mp4";
                                                Object.assign(video4.style, {
                                                  position: "fixed",
                                                  top: "0",
                                                  left: "0",
                                                  width: "100%",
                                                  height: "100%",
                                                  objectFit: "cover",
                                                  zIndex: "10"
                                                });
                                                video4.autoplay = true;
                                                video4.controls = false;
                                                video4.playsInline = true;
                                                video4.volume = 1.0;
                                                video4.setAttribute('controlsList', 'nodownload nofullscreen noremoteplayback');
                                                document.body.appendChild(video4);

                                                video4.addEventListener('play', () => {
                                                  createReflectionCaption(3);
                                                });
                                                let vid4Interval = setInterval(() => {
                                                  if (video4.currentTime >= 15) {
                                                    if (!document.getElementById('next-btn-4') && !document.getElementById('back-btn-4')) {
                                                      const next4 = document.createElement('button');
                                                      next4.id = 'next-btn-4';
                                                      next4.textContent = 'next';
                                                      Object.assign(next4.style, {
                                                        position: 'fixed',
                                                        bottom: '20px',
                                                        right: '20px',
                                                        padding: '10px 20px',
                                                        fontSize: '1em',
                                                        cursor: 'pointer',
                                                        borderRadius: '5px',
                                                        zIndex: 9999
                                                      });
                                                      document.body.appendChild(next4);

                                                      const back4 = document.createElement('button');
                                                      back4.id = 'back-btn-4';
                                                      back4.textContent = 'back';
                                                      Object.assign(back4.style, {
                                                        position: 'fixed',
                                                        bottom: '20px',
                                                        left: '20px',
                                                        padding: '10px 20px',
                                                        fontSize: '1em',
                                                        cursor: 'pointer',
                                                        borderRadius: '5px',
                                                        zIndex: 9999
                                                      });
                                                      document.body.appendChild(back4);

                                                      back4.addEventListener('click', () => {
                                                        removeReflectionCaption();
                                                        back4.remove();
                                                        next4.remove();
                                                        video4.pause();
                                                        video4.remove();
                                                        finalScene.style.transform = "scale(1)";
                                                      });

                                                      next4.addEventListener('click', () => {
                                                        removeReflectionCaption();
                                                        back4.remove();
                                                        next4.remove();
                                                        video4.pause();
                                                        video4.remove();
                                                        finalScene.style.transform = "scale(1)";

                                                        finalScene.addEventListener('transitionend', function zoomToVid5() {
                                                          finalScene.removeEventListener('transitionend', zoomToVid5);
                                                          const cardForVideo5 = cards[4];
                                                          if (!cardForVideo5) return;
                                                          const fsRect = finalScene.getBoundingClientRect();
                                                          const rect5 = cardForVideo5.getBoundingClientRect();
                                                          const cxf = rect5.left + rect5.width / 2 - fsRect.left;
                                                          const cyf = rect5.top + rect5.height / 2 - fsRect.top;
                                                          finalScene.style.transformOrigin = `${cxf}px ${cyf}px`;
                                                          finalScene.style.transform = "scale(80)";

                                                          finalScene.addEventListener('transitionend', function handlerZoomIn5() {
                                                            finalScene.removeEventListener('transitionend', handlerZoomIn5);
                                                            const video5 = document.createElement('video');
                                                            video5.src = "data5.mp4";
                                                            Object.assign(video5.style, {
                                                              position: "fixed",
                                                              top: "0",
                                                              left: "0",
                                                              width: "100%",
                                                              height: "100%",
                                                              objectFit: "cover",
                                                              zIndex: "10"
                                                            });
                                                            video5.autoplay = true;
                                                            video5.controls = false;
                                                            video5.playsInline = true;
                                                            video5.volume = 1.0;
                                                            video5.setAttribute('controlsList', 'nodownload nofullscreen noremoteplayback');
                                                            document.body.appendChild(video5);

                                                            video5.addEventListener('play', () => {
                                                              createReflectionCaption(4);
                                                            });
                                                            video5.addEventListener('ended', () => {
                                                              removeReflectionCaption();
                                                              markVideoWatched(4);
                                                            });

                                                            let nextButton5Shown = false;
                                                            video5.addEventListener('timeupdate', () => {
                                                              if (!nextButton5Shown && video5.currentTime >= 122) {
                                                                nextButton5Shown = true;
                                                                const next5 = document.createElement('button');
                                                                next5.id = 'next-btn-5';
                                                                next5.textContent = 'next';
                                                                Object.assign(next5.style, {
                                                                  position: 'fixed',
                                                                  bottom: '20px',
                                                                  right: '20px',
                                                                  padding: '10px 20px',
                                                                  fontSize: '1em',
                                                                  cursor: 'pointer',
                                                                  borderRadius: '5px',
                                                                  zIndex: 9999
                                                                });
                                                                document.body.appendChild(next5);

                                                                const back5 = document.createElement('button');
                                                                back5.id = 'back-btn-5';
                                                                back5.textContent = 'back';
                                                                Object.assign(back5.style, {
                                                                  position: 'fixed',
                                                                  bottom: '20px',
                                                                  left: '20px',
                                                                  padding: '10px 20px',
                                                                  fontSize: '1em',
                                                                  cursor: 'pointer',
                                                                  borderRadius: '5px',
                                                                  zIndex: 9999
                                                                });
                                                                document.body.appendChild(back5);

                                                                back5.addEventListener('click', () => {
                                                                  removeReflectionCaption();
                                                                  next5.remove();
                                                                  back5.remove();
                                                                  video5.pause();
                                                                  video5.remove();
                                                                  finalScene.style.transform = "scale(1)";
                                                                });

                                                                next5.addEventListener('click', () => {
                                                                  removeReflectionCaption();
                                                                  next5.remove();
                                                                  back5.remove();
                                                                  video5.pause();
                                                                  video5.remove();
                                                                  markVideoWatched(4);
                                                                  finalScene.style.transform = "scale(1)";

                                                                  finalScene.addEventListener('transitionend', function zoomToVid6() {
                                                                    finalScene.removeEventListener('transitionend', zoomToVid6);
                                                                    const cardForVideo6 = cards[5];
                                                                    if (!cardForVideo6) return;
                                                                    const fsRect = finalScene.getBoundingClientRect();
                                                                    const rect6 = cardForVideo6.getBoundingClientRect();
                                                                    const cxsix = rect6.left + rect6.width / 2 - fsRect.left;
                                                                    const cysix = rect6.top + rect6.height / 2 - fsRect.top;
                                                                    finalScene.style.transformOrigin = `${cxsix}px ${cysix}px`;
                                                                    finalScene.style.transform = "scale(80)";

                                                                    finalScene.addEventListener('transitionend', function handlerZoomIn6() {
                                                                      finalScene.removeEventListener('transitionend', handlerZoomIn6);
                                                                      const video6 = document.createElement('video');
                                                                      video6.src = "data6.mp4";
                                                                      Object.assign(video6.style, {
                                                                        position: "fixed",
                                                                        top: "0",
                                                                        left: "0",
                                                                        width: "100%",
                                                                        height: "100%",
                                                                        objectFit: "cover",
                                                                        zIndex: "10"
                                                                      });
                                                                      video6.autoplay = true;
                                                                      video6.controls = false;
                                                                      video6.playsInline = true;
                                                                      video6.setAttribute('controlsList', 'nodownload nofullscreen noremoteplayback');
                                                                      document.body.appendChild(video6);

                                                                      video6.addEventListener('play', () => {
                                                                        createReflectionCaption(5);
                                                                      });

                                                                      const catalogBtn = document.createElement('button');
                                                                      catalogBtn.id = 'catalog-btn-6';
                                                                      catalogBtn.innerText = 'catalog';
                                                                      Object.assign(catalogBtn.style, {
                                                                        position: 'fixed',
                                                                        bottom: '20px',
                                                                        right: '20px',
                                                                        padding: '10px 20px',
                                                                        fontSize: '1em',
                                                                        borderRadius: '5px',
                                                                        cursor: 'pointer',
                                                                        zIndex: 9999
                                                                      });
                                                                      document.body.appendChild(catalogBtn);

                                                                      const backBtn6 = document.createElement('button');
                                                                      backBtn6.id = 'back-btn-6';
                                                                      backBtn6.innerText = 'back';
                                                                      Object.assign(backBtn6.style, {
                                                                        position: 'fixed',
                                                                        bottom: '20px',
                                                                        left: '20px',
                                                                        padding: '10px 20px',
                                                                        fontSize: '1em',
                                                                        borderRadius: '5px',
                                                                        cursor: 'pointer',
                                                                        zIndex: 9999
                                                                      });
                                                                      document.body.appendChild(backBtn6);

                                                                      backBtn6.onclick = () => {
                                                                        removeReflectionCaption();
                                                                        catalogBtn.remove();
                                                                        backBtn6.remove();
                                                                        video6.pause();
                                                                        video6.remove();
                                                                        finalScene.style.transform = "scale(1)";

                                                                        finalScene.addEventListener('transitionend', function goBackToVideo5() {
                                                                          finalScene.removeEventListener('transitionend', goBackToVideo5);
                                                                          const cardVid5 = cards[4];
                                                                          if (!cardVid5) return;
                                                                          const cardRect5 = cardVid5.getBoundingClientRect();
                                                                          const centerX5 = cardRect5.left + cardRect5.width / 2 - fsRect.left;
                                                                          const centerY5 = cardRect5.top + cardRect5.height / 2 - fsRect.top;
                                                                          finalScene.style.transformOrigin = `${centerX5}px ${centerY5}px`;
                                                                          finalScene.style.transform = "scale(80)";

                                                                          finalScene.addEventListener('transitionend', function reEnterVideo5() {
                                                                            finalScene.removeEventListener('transitionend', reEnterVideo5);
                                                                            const video5again = document.createElement('video');
                                                                            video5again.src = "data5.mp4";
                                                                            Object.assign(video5again.style, {
                                                                              position: "fixed",
                                                                              top: "0",
                                                                              left: "0",
                                                                              width: "100%",
                                                                              height: "100%",
                                                                              objectFit: "cover",
                                                                              zIndex: "10"
                                                                            });
                                                                            video5again.autoplay = true;
                                                                            video5again.controls = false;
                                                                            video5again.playsInline = true;
                                                                            video5again.volume = 1.0;
                                                                            video5again.setAttribute('controlsList', 'nodownload nofullscreen noremoteplayback');
                                                                            document.body.appendChild(video5again);

                                                                            video5again.addEventListener('play', () => {
                                                                              createReflectionCaption(4);
                                                                            });
                                                                            video5again.addEventListener('ended', () => {
                                                                              removeReflectionCaption();
                                                                              markVideoWatched(4);
                                                                            });
                                                                          });
                                                                        });
                                                                      };

                                                                      catalogBtn.onclick = () => {
                                                                        removeReflectionCaption();
                                                                        catalogBtn.remove();
                                                                        backBtn6.remove();
                                                                        video6.pause();
                                                                        video6.remove();
                                                                        markVideoWatched(5);
                                                                        finalScene.style.transform = "scale(1)";
                                                                        // catalog is already visible & unlocked
                                                                      };

                                                                      video6.addEventListener('ended', () => {
                                                                        removeReflectionCaption();
                                                                        markVideoWatched(5);
                                                                        video6.remove();
                                                                        catalogBtn.remove();
                                                                        backBtn6.remove();
                                                                        finalScene.style.transform = "scale(1)";
                                                                        // same, show catalog
                                                                      });
                                                                    });
                                                                  });
                                                                });
                                                              }
                                                            });
                                                          });
                                                        });
                                                      });
                                                      clearInterval(vid4Interval);
                                                    }
                                                  }
                                                }, 500);

                                                video4.addEventListener('ended', () => {
                                                  removeReflectionCaption();
                                                  markVideoWatched(3);
                                                });
                                              });
                                            });
                                          });
                                        }
                                      });
                                    });
                                  });
                                });
                              });
                            }
                          });
                        });
                      });
                    });
                  });
                }
              });
            });
          });
        }, 2000);
      }

      /* 6.8) schedule the fade-out once music is near the end */
      function scheduleFadeOut() {
        const fadeTimeOffset = 6; // fade out 6s before track ends
        const remainingTime = backgroundMusic.duration - fadeTimeOffset - backgroundMusic.currentTime;
        if (remainingTime > 0) {
          setTimeout(fadeOutScene, remainingTime * 1000);
        } else {
          fadeOutScene();
        }
      }

      if (backgroundMusic.readyState > 0) {
        scheduleFadeOut();
      } else {
        backgroundMusic.addEventListener('loadedmetadata', scheduleFadeOut);
      }
    });
  </script>
</body>
</html>
